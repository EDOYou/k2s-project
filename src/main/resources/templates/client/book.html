<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Appointment</title>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    function updateHairdressers() {
      const serviceName = document.getElementById("serviceId").value;
      console.log("Selected service:", serviceName);

      const hairdressers = document.querySelectorAll("#hairdresserId option");

      hairdressers.forEach((hairdresser) => {
        const services = hairdresser.getAttribute("data-services").split(",");
        console.log("Hairdresser:", hairdresser.textContent, "Services:", services);

        // Additional debugging information
        services.forEach(service => {
          console.log("Comparing:", service, "with", serviceName, "Result:",
              service === serviceName);
        });

        const shouldDisplay = services.includes(serviceName);
        console.log("Should display hairdresser:", shouldDisplay);

        hairdresser.style.display = shouldDisplay ? "" : "none";
      });

      // Fetch time slots for the first visible hairdresser
      const firstVisibleHairdresser = Array.from(hairdressers).find(
          h => h.style.display !== 'none');
      if (firstVisibleHairdresser) {
        updateTimeSlots(firstVisibleHairdresser.value, serviceName);
      }
    }

    function updateTimeSlots(hairdresserId, serviceName) {
      axios.get('/client/timeslots', {
        params: {
          hairdresserId: hairdresserId,
          serviceName: serviceName
        }
      })
      .then(function (response) {
        console.log(response);
        const timeSlotDropdown = document.getElementById('timeSlotId');
        timeSlotDropdown.innerHTML = ''; // clear the dropdown

        console.log(response.data);
        // add each time slot to the dropdown
        response.data.forEach(slot => {
          const option = document.createElement('option');
          option.value = slot;
          option.textContent = slot;
          timeSlotDropdown.appendChild(option);
        });
      })
      .catch(function (error) {
        console.log(error);
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      updateHairdressers();
    });
  </script>
</head>
<body>
<h1>Book an Appointment</h1>
<form th:action="@{/client/book}" method="post">
  <label for="hairdresserId">Hairdresser:</label>
  <select id="hairdresserId" name="hairdresserId"
          onchange="updateTimeSlots(this.value, document.getElementById('serviceId').value)">
    <option th:each="hairdresser : ${hairdressers}"
            th:value="${hairdresser.id}"
            th:text="${hairdresser.firstName + ' ' + hairdresser.lastName}"
            th:attr="data-services=${#strings.replace(#strings.replace(hairdresser.getBeautyServicesNames(), '[', ''), ']', '')}">
    </option>
  </select>

  <br>

  <label for="serviceId">Service:</label>
  <select id="serviceId" name="serviceName" onchange="updateHairdressers()">
    <option th:each="serviceName : ${services}"
            th:value="${serviceName}"
            th:text="${serviceName}">
    </option>
  </select>

  <br>
  <label for="timeSlotId">Time Slot:</label>
  <select id="timeSlotId" name="dateTime">
    <!-- Time slot options will be populated by JavaScript -->
  </select>

  <br>

  <button type="submit">Book Appointment</button>
</form>
</body>
</html>